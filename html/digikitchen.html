<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Calorie Kitchen</title>
    <link rel="stylesheet" href="../css/digikitchen.css">
</head>
<body>
    <div class="container">
        <!-- Cooking Pan Header -->
        <div class="cooking-header">
            <div class="cooking-pan-container">
                <div class="cooking-pan" id="cookingPan">
                    <img src="../media/cookingpanemoji.png" alt="Cooking Pan">
                    <div class="pan-contents" id="panContents">
                        <!-- Dropped food items will appear here -->
                    </div>
                </div>
            </div>
            <h1 class="kitchen-title">Digital Calorie Kitchen</h1>
            <p class="kitchen-subtitle">Drag food into the pan to cook!</p>
        </div>

        <!-- Food Counter -->
        <div class="food-counter">
            <div class="counter-header">
                <h2 class="counter-title">üçΩÔ∏è Food Selection Counter</h2>
                <div class="total-calories">
                    Total: <span id="totalCalories">0</span> kcal
                </div>
            </div>

            <!-- Food Category Legend -->
            <div class="category-legend">
                <div class="legend-item">ü•© Protein</div>
                <div class="legend-item">ü•õ Dairy</div>
                <div class="legend-item">üßà Fats</div>
                <div class="legend-item">üåæ Grains</div>
                <div class="legend-item">ü•î Carbs</div>
                <div class="legend-item">ü•¨ Vegetables</div>
                <div class="legend-item">üçé Fruits</div>
            </div>

            <!-- Horizontal Scrolling Food Menu -->
            <div class="food-menu-wrapper">
                <button class="scroll-button scroll-left" id="scrollLeft">‚Äπ</button>
                <div class="food-scroll-menu" id="foodScrollMenu">
                    <!-- Food items will be populated by JavaScript -->
                </div>
                <button class="scroll-button scroll-right" id="scrollRight">‚Ä∫</button>
            </div>
        </div>

        <!-- Selected Items -->
        <div class="selected-items">
            <h3>üìã Din M√•ltidsrapport</h3>
            <div id="selectedItems">
                <p style="color: #666; font-style: italic;">Ingen varer valgt enn√•. Start √• bygge m√•ltidet ditt!</p>
            </div>
            
            <!-- Nutrition Report -->
            <div id="nutritionReport" style="display: none;">
                <h4 style="color: #333; margin-top: 20px; margin-bottom: 15px;">üçΩÔ∏è Komplett N√¶ringsrapport</h4>
                <div class="nutrition-summary">
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <span class="nutrition-label">Total Kalorier:</span>
                            <span class="nutrition-value" id="totalKcal">0 kcal</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Protein:</span>
                            <span class="nutrition-value" id="totalProtein">0 g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Fett:</span>
                            <span class="nutrition-value" id="totalFat">0 g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Karbohydrater:</span>
                            <span class="nutrition-value" id="totalCarbs">0 g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Kolesterol:</span>
                            <span class="nutrition-value" id="totalCholesterol">0 mg</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Kollagen:</span>
                            <span class="nutrition-value" id="totalCollagen">0 g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Vitamin C:</span>
                            <span class="nutrition-value" id="totalVitaminC">0 mg</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Kalsium:</span>
                            <span class="nutrition-value" id="totalCalcium">0 mg</span>
                        </div>
                    </div>
                    
                    <div class="fat-type-breakdown" style="margin-top: 15px;">
                        <h5 style="color: #555; margin-bottom: 10px;">Fetttype Analyse:</h5>
                        <div id="fatTypeBreakdown">
                            <div class="fat-type healthy">Sunt fett: <span id="healthyFat">0 g</span></div>
                            <div class="fat-type mixed">Blandet fett: <span id="mixedFat">0 g</span></div>
                            <div class="fat-type unhealthy">Usunt fett: <span id="unhealthyFat">0 g</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button class="settings-button" id="settingsButton">‚öôÔ∏è</button>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-panel">
            <div class="settings-header">
                <h3 class="settings-title">‚öôÔ∏è Porsjonsinnstillinger</h3>
                <button class="close-settings" id="closeSettings">‚úï</button>
            </div>
            
            <div class="portion-multiplier">
                <h4>üìè Globale Porsjoner</h4>
                <div class="multiplier-controls">
                    <button class="multiplier-button" id="decreaseMultiplier">-</button>
                    <span class="multiplier-display" id="multiplierDisplay">1.0x</span>
                    <button class="multiplier-button" id="increaseMultiplier">+</button>
                </div>
                <div class="portion-info">
                    Standard multiplikator for nye ingredienser
                </div>
                <button class="reset-button" id="resetMultiplier">Tilbakestill alle</button>
            </div>

            <div style="margin-top: 20px;">
                <h4>ü•ò Individuelle Ingredienser:</h4>
                <div id="individualPortions">
                    <p style="color: #666; font-style: italic;">Ingen ingredienser valgt enn√•</p>
                </div>
            </div>

            <div style="margin-top: 18px; border-top: 1px solid rgba(0,0,0,0.06); padding-top: 12px;">
                <h4>‚ûï Legg til Egendefinert Ingrediens</h4>
                <p style="color:#666; margin-top: -6px; margin-bottom: 8px;">Lag en rask ingrediens som vises i scrolleren (midlertidig, lagres ikke ved oppdatering).</p>
                <button class="add-ingredient-button" id="addIngredientBtn" style="padding:6px 10px; border-radius:8px; background:#f0f0f0; border:1px solid #ddd; cursor:pointer;">+ Legg til ingrediens</button>

                <form id="addIngredientForm" style="display:none; margin-top:12px; gap:8px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <label style="flex:1 1 200px; font-size:13px; color:#333;">Navn:<br><input name="name" required style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 160px; font-size:13px; color:#333;">Kategori:<br>
                            <select name="category" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                                <option value="protein">Protein</option>
                                <option value="dairy">Dairy</option>
                                <option value="fat">Fat</option>
                                <option value="grain">Grain</option>
                                <option value="carbs">Carbs</option>
                                <option value="vegetable">Vegetable</option>
                                <option value="fruit">Fruit</option>
                            </select>
                        </label>
                        <label style="flex:1 1 160px; font-size:13px; color:#333;">Portion (tekst):<br><input name="portion" placeholder="f.eks. 1 eple" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                    </div>

                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                        <label style="flex:1 1 100px; font-size:13px; color:#333;">Kcal:<br><input type="number" name="kcal" step="1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 100px; font-size:13px; color:#333;">Protein g:<br><input type="number" name="protein_g" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 100px; font-size:13px; color:#333;">Fat g:<br><input type="number" name="fat_g" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 120px; font-size:13px; color:#333;">Fetttype:<br>
                            <select name="fat_type" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                                <option value="healthy">Sunt</option>
                                <option value="mixed">Blandet</option>
                                <option value="unhealthy">Usunt</option>
                            </select>
                        </label>
                    </div>

                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                        <label style="flex:1 1 100px; font-size:13px; color:#333;">Carbs g:<br><input type="number" name="carbs_g" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 120px; font-size:13px; color:#333;">Cholesterol mg:<br><input type="number" name="cholesterol_mg" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 120px; font-size:13px; color:#333;">Collagen g:<br><input type="number" name="collagen_g" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 120px; font-size:13px; color:#333;">Vitamin C mg:<br><input type="number" name="vitaminC_mg" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                        <label style="flex:1 1 120px; font-size:13px; color:#333;">Calcium mg:<br><input type="number" name="calcium_mg" step="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;"></label>
                    </div>

                    <div style="margin-top:10px; display:flex; gap:8px;">
                        <button type="submit" style="padding:8px 10px; border-radius:8px;">Legg til</button>
                        <button type="button" id="cancelAddIngredient" style="padding:8px 10px; border-radius:8px; background:#fff; border:1px solid #ddd;">Avbryt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../javasc/foods.js"></script>
    <script>
        let selectedFoods = [];
        let totalCalories = 0;
        let panFoods = [];
        let portionMultiplier = 1.0;
        let individualMultipliers = {}; // Stor multiplier per matbit

        // Function to get category emoji
        function getCategoryEmoji(category) {
            const emojis = {
                'protein': 'ü•©',
                'dairy': 'ü•õ',
                'fat': 'üßà',
                'grain': 'üåæ',
                'starch': 'ü•î',  // editet dette for √• bruke gamle funksjoner, men la til carbs istedenfor for √• vise det riktige.
                'carbs': 'ü•î',   // Add carbs as synonym
                'vegetable': 'ü•¨',
                'fruit': 'üçé'
            };
            return emojis[category] || 'üçΩÔ∏è';
        }

        // Function to display horizontal scrolling food menu with drag functionality
        function displayFoodScrollMenu() {
            const scrollMenuContainer = document.getElementById('foodScrollMenu');
            scrollMenuContainer.innerHTML = '';

            foods.forEach((food, index) => {
                const scrollItem = document.createElement('div');
                scrollItem.className = 'food-scroll-item';
                scrollItem.draggable = true;
                scrollItem.dataset.foodIndex = index;
                scrollItem.innerHTML = `
                    <span class="food-scroll-emoji">${getCategoryEmoji(food.category)}</span>
                    <div class="food-scroll-name">${food.name}</div>
                    <div class="food-scroll-calories">${food.kcal} kcal</div>
                `;
                
                // Add drag event listeners
                scrollItem.addEventListener('dragstart', handleDragStart);
                scrollItem.addEventListener('dragend', handleDragEnd);
                
                scrollMenuContainer.appendChild(scrollItem);
            });
        }

        // Drag and Drop Event Handlers
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.foodIndex);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const foodIndex = e.dataTransfer.getData('text/plain');
            const food = foods[parseInt(foodIndex)];
            
            // Add food to pan
            addFoodToPan(food);
        }

        // Function to add food to pan with portion multiplier
        function addFoodToPan(food) {
            const foodId = food.name;
            // Use individual multiplier if exists, otherwise use global
            const multiplier = individualMultipliers[foodId] || portionMultiplier;
            const adjustedFood = adjustFoodPortion(food, multiplier);
            
            // Store the original food reference and multiplier
            adjustedFood.originalName = food.name;
            adjustedFood.currentMultiplier = multiplier;
            
            panFoods.push(adjustedFood);
            selectedFoods.push(adjustedFood);
            totalCalories += adjustedFood.kcal;
            
            // Initialize individual multiplier if not exists
            if (!individualMultipliers[foodId]) {
                individualMultipliers[foodId] = multiplier;
            }
            
            updatePanContents();
            updateSelectedItems();
            updateTotalCalories();
            updateIndividualPortions();
        }

        // Function to adjust food portion based on multiplier
        function adjustFoodPortion(food, multiplier) {
            return {
                ...food,
                kcal: Math.round(food.kcal * multiplier),
                protein_g: Math.round((food.protein_g * multiplier) * 10) / 10,
                fat_g: Math.round((food.fat_g * multiplier) * 10) / 10,
                carbs_g: Math.round((food.carbs_g * multiplier) * 10) / 10,
                cholesterol_mg: Math.round((food.cholesterol_mg * multiplier) * 10) / 10,
                collagen_g: Math.round((food.collagen_g * multiplier) * 10) / 10,
                vitaminC_mg: Math.round((food.vitaminC_mg * multiplier) * 10) / 10,
                calcium_mg: Math.round((food.calcium_mg * multiplier) * 10) / 10,
                portion: updatePortionText(food.portion, multiplier)
            };
        }

        // Function to update portion text
        function updatePortionText(originalPortion, multiplier) {
            if (multiplier === 1.0) return originalPortion;
            return `${originalPortion} (${multiplier}x)`;
        }

        // Function to update pan contents
        function updatePanContents() {
            const panContents = document.getElementById('panContents');
            panContents.innerHTML = '';
            
            panFoods.forEach((food) => {
                const foodEmoji = document.createElement('span');
                foodEmoji.className = 'pan-food-item';
                foodEmoji.textContent = getCategoryEmoji(food.category);
                panContents.appendChild(foodEmoji);
            });
        }

        // Scroll button functionality
        function setupScrollButtons() {
            const scrollMenu = document.getElementById('foodScrollMenu');
            const scrollLeft = document.getElementById('scrollLeft');
            const scrollRight = document.getElementById('scrollRight');
            
            scrollLeft.addEventListener('click', () => {
                scrollMenu.scrollBy({ left: -200, behavior: 'smooth' });
            });
            
            scrollRight.addEventListener('click', () => {
                scrollMenu.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }



        // Function to remove food from selection
        function removeFood(index) {
            const removedFood = selectedFoods.splice(index, 1)[0];
            totalCalories -= removedFood.kcal;
            
            // Also remove from pan if it exists there
            const panIndex = panFoods.findIndex(food => food.name === removedFood.name);
            if (panIndex !== -1) {
                panFoods.splice(panIndex, 1);
                updatePanContents();
            }
            
            // Check if this was the last instance of this food
            const remainingCount = selectedFoods.filter(f => f.originalName === removedFood.originalName).length;
            if (remainingCount === 0) {
                delete individualMultipliers[removedFood.originalName];
            }
            
            updateSelectedItems();
            updateTotalCalories();
            updateIndividualPortions();
        }

        // Function to update selected items display
        function updateSelectedItems() {
            const selectedItemsContainer = document.getElementById('selectedItems');
            const nutritionReport = document.getElementById('nutritionReport');
            
            if (selectedFoods.length === 0) {
                selectedItemsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Ingen varer valgt enn√•. Start √• bygge m√•ltidet ditt!</p>';
                nutritionReport.style.display = 'none';
                return;
            }

            // Show selected items
            selectedItemsContainer.innerHTML = '';
            selectedFoods.forEach((food, index) => {
                const item = document.createElement('div');
                item.className = 'selected-item';
                item.innerHTML = `
                    <span>${getCategoryEmoji(food.category)} ${food.name} - ${food.kcal} kcal</span>
                    <button class="remove-button" onclick="removeFood(${index})">Fjern</button>
                `;
                selectedItemsContainer.appendChild(item);
            });

            // Show and update nutrition report
            nutritionReport.style.display = 'block';
            updateNutritionReport();
        }

        // Function to calculate and update nutrition report
        function updateNutritionReport() {
            let totals = {
                kcal: 0,
                protein: 0,
                fat: 0,
                carbs: 0,
                cholesterol: 0,
                collagen: 0,
                vitaminC: 0,
                calcium: 0,
                healthyFat: 0,
                mixedFat: 0,
                unhealthyFat: 0
            };

            // Calculate totals
            selectedFoods.forEach(food => {
                totals.kcal += food.kcal;
                totals.protein += food.protein_g;
                totals.fat += food.fat_g;
                totals.carbs += food.carbs_g;
                totals.cholesterol += food.cholesterol_mg;
                totals.collagen += food.collagen_g;
                totals.vitaminC += food.vitaminC_mg;
                totals.calcium += food.calcium_mg;

                // Fat type breakdown
                if (food.fat_type === 'healthy') {
                    totals.healthyFat += food.fat_g;
                } else if (food.fat_type === 'mixed') {
                    totals.mixedFat += food.fat_g;
                } else if (food.fat_type === 'unhealthy') {
                    totals.unhealthyFat += food.fat_g;
                }
            });

            // Update the display
            document.getElementById('totalKcal').textContent = `${totals.kcal} kcal`;
            document.getElementById('totalProtein').textContent = `${totals.protein.toFixed(1)} g`;
            document.getElementById('totalFat').textContent = `${totals.fat.toFixed(1)} g`;
            document.getElementById('totalCarbs').textContent = `${totals.carbs.toFixed(1)} g`;
            document.getElementById('totalCholesterol').textContent = `${totals.cholesterol.toFixed(1)} mg`;
            document.getElementById('totalCollagen').textContent = `${totals.collagen.toFixed(1)} g`;
            document.getElementById('totalVitaminC').textContent = `${totals.vitaminC.toFixed(1)} mg`;
            document.getElementById('totalCalcium').textContent = `${totals.calcium.toFixed(1)} mg`;

            // Fat type breakdown
            document.getElementById('healthyFat').textContent = `${totals.healthyFat.toFixed(1)} g`;
            document.getElementById('mixedFat').textContent = `${totals.mixedFat.toFixed(1)} g`;
            document.getElementById('unhealthyFat').textContent = `${totals.unhealthyFat.toFixed(1)} g`;
        }

        // Function to update total calories
        function updateTotalCalories() {
            document.getElementById('totalCalories').textContent = totalCalories;
        }

        // Setup drag and drop for cooking pan
        function setupDragAndDrop() {
            const cookingPan = document.getElementById('cookingPan');
            
            cookingPan.addEventListener('dragover', handleDragOver);
            cookingPan.addEventListener('dragleave', handleDragLeave);
            cookingPan.addEventListener('drop', handleDrop);
        }

        // Settings functionality
        function setupSettings() {
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettings = document.getElementById('closeSettings');
            const decreaseMultiplier = document.getElementById('decreaseMultiplier');
            const increaseMultiplier = document.getElementById('increaseMultiplier');
            const resetMultiplier = document.getElementById('resetMultiplier');
            const multiplierDisplay = document.getElementById('multiplierDisplay');

            // Open settings
            settingsButton.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                updateIndividualPortions();
            });

            // Close settings
            closeSettings.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });

            // Close on backdrop click
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });

            // Decrease multiplier
            decreaseMultiplier.addEventListener('click', () => {
                if (portionMultiplier > 0.1) {
                    portionMultiplier = Math.round((portionMultiplier - 0.1) * 10) / 10;
                    updateMultiplierDisplay();
                    updateMultiplierEffect();
                }
            });

            // Increase multiplier
            increaseMultiplier.addEventListener('click', () => {
                if (portionMultiplier < 5.0) {
                    portionMultiplier = Math.round((portionMultiplier + 0.1) * 10) / 10;
                    updateMultiplierDisplay();
                    updateMultiplierEffect();
                }
            });

            // Reset multiplier
            resetMultiplier.addEventListener('click', () => {
                portionMultiplier = 1.0;
                // Reset all individual multipliers to 1.0
                Object.keys(individualMultipliers).forEach(key => {
                    individualMultipliers[key] = 1.0;
                });
                recalculateSelectedFoods();
                updateMultiplierDisplay();
                updateIndividualPortions();
            });

            // Add-ingredient UI wiring
            const addIngredientBtn = document.getElementById('addIngredientBtn');
            const addIngredientForm = document.getElementById('addIngredientForm');
            const cancelAddIngredient = document.getElementById('cancelAddIngredient');
            if (addIngredientBtn) addIngredientBtn.addEventListener('click', (e) => { e.preventDefault(); showAddIngredientForm(); });
            if (cancelAddIngredient) cancelAddIngredient.addEventListener('click', (e) => { e.preventDefault(); hideAddIngredientForm(); });
            if (addIngredientForm) addIngredientForm.addEventListener('submit', (e) => { e.preventDefault(); addCustomIngredient(); });

            // Initialize display
            updateMultiplierDisplay();
        }

        function updateMultiplierDisplay() {
            const multiplierDisplay = document.getElementById('multiplierDisplay');
            multiplierDisplay.textContent = `${portionMultiplier.toFixed(1)}x`;
        }

        // Add-ingredient helpers
        function showAddIngredientForm() {
            const f = document.getElementById('addIngredientForm');
            if (f) f.style.display = 'block';
        }

        function hideAddIngredientForm() {
            const f = document.getElementById('addIngredientForm');
            if (f) {
                f.style.display = 'none';
                try { f.reset(); } catch(e) {}
            }
        }

        function addCustomIngredient() {
            const form = document.getElementById('addIngredientForm');
            if (!form) return;
            const formData = new FormData(form);
            const name = (formData.get('name') || '').toString().trim();
            if (!name) { alert('Vennligst skriv inn et navn for ingrediensen.'); return; }

            const category = formData.get('category') || 'vegetable';
            const portion = formData.get('portion') || '1 portion';
            const kcal = Number(formData.get('kcal')) || 0;
            const protein_g = Number(formData.get('protein_g')) || 0;
            const fat_g = Number(formData.get('fat_g')) || 0;
            const fat_type = formData.get('fat_type') || 'mixed';
            const carbs_g = Number(formData.get('carbs_g')) || 0;
            const cholesterol_mg = Number(formData.get('cholesterol_mg')) || 0;
            const collagen_g = Number(formData.get('collagen_g')) || 0;
            const vitaminC_mg = Number(formData.get('vitaminC_mg')) || 0;
            const calcium_mg = Number(formData.get('calcium_mg')) || 0;

            const newFood = {
                name,
                category,
                portion,
                kcal,
                protein_g,
                fat_g,
                fat_type,
                carbs_g,
                cholesterol_mg,
                collagen_g,
                vitaminC_mg,
                calcium_mg
            };

            // Add to foods array and refresh UI
            foods.push(newFood);
            // set default individual multiplier for this ingredient to current global portionMultiplier
            individualMultipliers[name] = portionMultiplier;
            displayFoodScrollMenu();
            updateIndividualPortions();
            hideAddIngredientForm();
        }

        function updateIndividualPortions() {
            const container = document.getElementById('individualPortions');
            
            if (Object.keys(individualMultipliers).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Ingen ingredienser valgt enn√•</p>';
                return;
            }

            container.innerHTML = '';
            
            Object.keys(individualMultipliers).forEach(foodName => {
                const originalFood = foods.find(f => f.name === foodName);
                if (!originalFood) return;
                
                const multiplier = individualMultipliers[foodName];
                const adjustedFood = adjustFoodPortion(originalFood, multiplier);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ingredient-item';
                itemDiv.innerHTML = `
                    <div class="ingredient-info">
                        <div class="ingredient-name">${getCategoryEmoji(originalFood.category)} ${foodName}</div>
                        <div class="ingredient-stats">${adjustedFood.kcal} kcal, ${adjustedFood.protein_g}g protein</div>
                    </div>
                    <div class="ingredient-controls">
                        <button class="ingredient-multiplier-btn" onclick="adjustIndividualPortion('${foodName}', -0.1)">-</button>
                        <span class="ingredient-multiplier-display">${multiplier.toFixed(1)}x</span>
                        <button class="ingredient-multiplier-btn" onclick="adjustIndividualPortion('${foodName}', 0.1)">+</button>
                        <button class="remove-ingredient-btn" onclick="removeAllOfIngredient('${foodName}')">‚úï</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function adjustIndividualPortion(foodName, change) {
            if (!individualMultipliers[foodName]) return;
            
            const newMultiplier = Math.max(0.1, Math.min(5.0, 
                Math.round((individualMultipliers[foodName] + change) * 10) / 10
            ));
            
            individualMultipliers[foodName] = newMultiplier;
            
            // Update all instances of this food in selected foods
            recalculateSelectedFoods();
            updateIndividualPortions();
        }

        function removeAllOfIngredient(foodName) {
            // Remove all instances of this food
            selectedFoods = selectedFoods.filter(food => food.originalName !== foodName);
            panFoods = panFoods.filter(food => food.originalName !== foodName);
            
            // Remove from individual multipliers
            delete individualMultipliers[foodName];
            
            // Recalculate totals
            recalculateTotalCalories();
            updateSelectedItems();
            updatePanContents();
            updateIndividualPortions();
        }

        function recalculateSelectedFoods() {
            // Update all selected foods with new multipliers
            selectedFoods = selectedFoods.map(food => {
                const originalFood = foods.find(f => f.name === food.originalName);
                const multiplier = individualMultipliers[food.originalName] || 1.0;
                const adjustedFood = adjustFoodPortion(originalFood, multiplier);
                adjustedFood.originalName = food.originalName;
                adjustedFood.currentMultiplier = multiplier;
                return adjustedFood;
            });
            
            // Update pan foods
            panFoods = panFoods.map(food => {
                const originalFood = foods.find(f => f.name === food.originalName);
                const multiplier = individualMultipliers[food.originalName] || 1.0;
                const adjustedFood = adjustFoodPortion(originalFood, multiplier);
                adjustedFood.originalName = food.originalName;
                adjustedFood.currentMultiplier = multiplier;
                return adjustedFood;
            });
            
            recalculateTotalCalories();
            updateSelectedItems();
            updatePanContents();
        }

        function recalculateTotalCalories() {
            totalCalories = selectedFoods.reduce((sum, food) => sum + food.kcal, 0);
            updateTotalCalories();
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            displayFoodScrollMenu();
            setupScrollButtons();
            setupDragAndDrop();
            setupSettings();
        });
    </script>
</body>
</html>
